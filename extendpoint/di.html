<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dependency injection | YoyoGo</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://mnur-prod-public.oss-cn-beijing.aliyuncs.com/0/tech/yoyogo.png">
    <script>
              var _hmt = _hmt || [];
              </script>
    <meta name="description" content="简单、轻量、快速、基于依赖注入的微服务框架">
    <meta description="简单、轻量、快速、基于依赖注入的微服务框架">
    
    <link rel="preload" href="/assets/css/0.styles.c69bfb3a.css" as="style"><link rel="preload" href="/assets/js/app.fbf17916.js" as="script"><link rel="preload" href="/assets/js/2.fff6d63b.js" as="script"><link rel="preload" href="/assets/js/16.a7f4b20a.js" as="script"><link rel="prefetch" href="/assets/js/10.faafe96a.js"><link rel="prefetch" href="/assets/js/11.bab3523d.js"><link rel="prefetch" href="/assets/js/12.039940f7.js"><link rel="prefetch" href="/assets/js/13.e800a74f.js"><link rel="prefetch" href="/assets/js/14.13d5e579.js"><link rel="prefetch" href="/assets/js/15.5c748d07.js"><link rel="prefetch" href="/assets/js/17.1917d6f0.js"><link rel="prefetch" href="/assets/js/18.1e817500.js"><link rel="prefetch" href="/assets/js/19.d5981455.js"><link rel="prefetch" href="/assets/js/20.a01cf94a.js"><link rel="prefetch" href="/assets/js/21.8ccafceb.js"><link rel="prefetch" href="/assets/js/22.bd4c8d3a.js"><link rel="prefetch" href="/assets/js/23.575d39f1.js"><link rel="prefetch" href="/assets/js/24.10f150db.js"><link rel="prefetch" href="/assets/js/25.09f0327a.js"><link rel="prefetch" href="/assets/js/26.43ae157a.js"><link rel="prefetch" href="/assets/js/27.c3c138c0.js"><link rel="prefetch" href="/assets/js/28.966aaba4.js"><link rel="prefetch" href="/assets/js/29.0a1768a8.js"><link rel="prefetch" href="/assets/js/3.67340cd7.js"><link rel="prefetch" href="/assets/js/30.97c88f0a.js"><link rel="prefetch" href="/assets/js/31.8ff4a86d.js"><link rel="prefetch" href="/assets/js/32.a93cc8a9.js"><link rel="prefetch" href="/assets/js/33.53d2d079.js"><link rel="prefetch" href="/assets/js/34.0be78700.js"><link rel="prefetch" href="/assets/js/35.409e685c.js"><link rel="prefetch" href="/assets/js/36.344a79c0.js"><link rel="prefetch" href="/assets/js/37.be24cf9e.js"><link rel="prefetch" href="/assets/js/38.1648554e.js"><link rel="prefetch" href="/assets/js/39.cb2f4fd7.js"><link rel="prefetch" href="/assets/js/4.444ec0ae.js"><link rel="prefetch" href="/assets/js/40.cff3a796.js"><link rel="prefetch" href="/assets/js/41.bc4a1d73.js"><link rel="prefetch" href="/assets/js/42.68570ecc.js"><link rel="prefetch" href="/assets/js/43.246c279c.js"><link rel="prefetch" href="/assets/js/5.72295ae3.js"><link rel="prefetch" href="/assets/js/6.5f591e3b.js"><link rel="prefetch" href="/assets/js/7.3cd5e9fa.js"><link rel="prefetch" href="/assets/js/8.8e867f78.js"><link rel="prefetch" href="/assets/js/9.b820454b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c69bfb3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://mnur-prod-public.oss-cn-beijing.aliyuncs.com/0/tech/yoyogo.png" alt="YoyoGo" class="logo"> <span class="site-name can-hide">YoyoGo</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/quickstart/begin.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="https://github.com/yoyofx/yoyogo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  源码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/yoyofx/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/quickstart/begin.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="https://github.com/yoyofx/yoyogo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  源码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/yoyofx/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/quickstart/begin.html" class="sidebar-link">快速预览</a></li><li><a href="/quickstart/YoyoGo微服务框架入门系列-基础入门--基本概念.html" class="sidebar-link">基本概念</a></li><li><a href="/quickstart/Advanced-Example.html" class="sidebar-link">代码展示</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务配置</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web Hosting</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>gRPC Hosting</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Console Hosting</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务-服务发现</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>高级特性</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/extendpoint/di.html" aria-current="page" class="active sidebar-link">依赖注入 - dependencyinjection</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/extendpoint/di.html#examples" class="sidebar-link">Examples</a></li><li class="sidebar-sub-header"><a href="/extendpoint/di.html#how-will-dependency-injection-help-me" class="sidebar-link">How will dependency injection help me?</a></li><li class="sidebar-sub-header"><a href="/extendpoint/di.html#contents" class="sidebar-link">Contents</a></li><li class="sidebar-sub-header"><a href="/extendpoint/di.html#installing" class="sidebar-link">Installing</a></li><li class="sidebar-sub-header"><a href="/extendpoint/di.html#advanced-features" class="sidebar-link">Advanced features</a></li><li class="sidebar-sub-header"><a href="/extendpoint/di.html#visualization" class="sidebar-link">Visualization</a></li></ul></li><li><a href="/extendpoint/hostservice.html" class="sidebar-link">扩展点 - HostService接口</a></li></ul></section></li><li><a href="/logs/日志.html" class="sidebar-link">服务日志</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具库</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dependency-injection"><a href="#dependency-injection" class="header-anchor">#</a> Dependency injection</h1> <p>Dependency injection for Go programming language.</p> <p>Dependency injection is one form of the broader technique of inversion of control. It is used to increase modularity of the program and make it extensible.</p> <h2 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> A <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>A <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NewSource</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	name <span class="token operator">:=</span> <span class="token string">&quot;A-&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>A<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> ls<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

services <span class="token operator">:=</span> <span class="token function">NewServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>NewA<span class="token punctuation">)</span>
<span class="token comment">//serviceCollection.AddSingletonByImplementsAndName(&quot;redis-master&quot;, NewRedis, new(abstractions.IDataSource))</span>
<span class="token comment">//serviceCollection.AddTransientByImplements(NewRedisClient, new(redis.IClient))</span>
<span class="token comment">//serviceCollection.AddTransientByImplements(NewRedisHealthIndicator, new(health.Indicator))</span>
serviceProvider <span class="token operator">:=</span> services<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> env <span class="token operator">*</span>A
<span class="token boolean">_</span> <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token function">GetService</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">)</span> <span class="token comment">// used</span>
</code></pre></div><h2 id="how-will-dependency-injection-help-me"><a href="#how-will-dependency-injection-help-me" class="header-anchor">#</a> How will dependency injection help me?</h2> <p>Dependency injection is one form of the broader technique of inversion
of control. It is used to increase modularity of the program and make it
extensible.</p> <h2 id="contents"><a href="#contents" class="header-anchor">#</a> Contents</h2> <ul><li><a href="#installing">Installing</a></li> <li><a href="#tutorial">Tutorial</a> <ul><li><a href="#providing">Providing</a></li> <li><a href="#extraction">Extraction</a></li> <li><a href="#invocation">Invocation</a></li> <li><a href="#lazy-loading">Lazy-loading</a></li> <li><a href="#interfaces">Interfaces</a></li> <li><a href="#groups">Groups</a></li></ul></li> <li><a href="#advanced-features">Advanced features</a> <ul><li><a href="#named-definitions">Named definitions</a></li> <li><a href="#optional-parameters">Optional parameters</a></li> <li><a href="#parameter-bag">Parameter Bag</a></li> <li><a href="#prototypes">Prototypes</a></li> <li><a href="#cleanup">Cleanup</a></li> <li><a href="#visualization">Visualization</a></li></ul></li> <li><a href="#contributing">Contributing</a></li></ul> <h2 id="installing"><a href="#installing" class="header-anchor">#</a> Installing</h2> <div class="language-shell extra-class"><pre class="language-shell"><code>go get -u github.com/yoyofxteam/dependencyinjection@v1.0.0
</code></pre></div><h3 id="providing"><a href="#providing" class="header-anchor">#</a> Providing</h3> <p>To start, we will need to create two fundamental types: <code>http.Server</code>
and <code>http.ServeMux</code>. Let's create a simple constructors that initialize
it:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// NewServer creates a http server with provided mux as handler.</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>mux <span class="token operator">*</span>http<span class="token punctuation">.</span>ServeMux<span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Server <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Handler<span class="token punctuation">:</span> mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewServeMux creates a new http serve mux.</span>
<span class="token keyword">func</span> <span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>ServeMux <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>ServeMux<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Supported constructor signature:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span>dep1<span class="token punctuation">,</span> dep2<span class="token punctuation">,</span> depN<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token punctuation">[</span>cleanup<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div></blockquote> <p>Now let's teach a container to build these types.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  di <span class="token string">&quot;github.com/yoyofxteam/dependencyinjection&quot;</span>
<span class="token punctuation">)</span>

container <span class="token operator">:=</span> di<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
	<span class="token comment">// provide http server</span>
    di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// provide http serve mux</span>
    di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServeMux<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>The function <code>di.New()</code> parse our constructors, compile dependency
graph and return <code>*di.Container</code> type for interaction. Container
panics if it could not compile.</p> <blockquote><p>I think that panic at the initialization of the application and not in
runtime is usual.</p></blockquote> <h3 id="extraction"><a href="#extraction" class="header-anchor">#</a> Extraction</h3> <p>We can extract the built server from the container. For this, define the
variable of extracted type and pass variable pointer to <code>Extract</code>
function.</p> <blockquote><p>If extracted type not found or the process of building instance cause
error, <code>Extract</code> return error.</p></blockquote> <p>If no error occurred, we can use the variable as if we had built it
yourself.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// declare type variable</span>
<span class="token keyword">var</span> server <span class="token operator">*</span>http<span class="token punctuation">.</span>Server
<span class="token comment">// extracting</span>
err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">// check extraction error</span>
<span class="token punctuation">}</span>

server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>Note that by default, the container creates instances as a singleton.
But you can change this behaviour. See <a href="#prototypes">Prototypes</a>.</p></blockquote> <h3 id="invocation"><a href="#invocation" class="header-anchor">#</a> Invocation</h3> <p>As an alternative to extraction we can use <code>Invoke()</code> function. It
resolves function dependencies and call the function. Invoke function
may return optional error.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// StartServer starts the server.</span>
<span class="token keyword">func</span> <span class="token function">StartServer</span><span class="token punctuation">(</span>server <span class="token operator">*</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

container<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>StartServer<span class="token punctuation">)</span>
</code></pre></div><h3 id="lazy-loading"><a href="#lazy-loading" class="header-anchor">#</a> Lazy-loading</h3> <p>Result dependencies will be lazy-loaded. If no one requires a type from
the container it will not be constructed.</p> <h3 id="interfaces"><a href="#interfaces" class="header-anchor">#</a> Interfaces</h3> <p>Inject make possible to provide implementation as an interface.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// NewServer creates a http server with provided mux as handler.</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Server <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Handler<span class="token punctuation">:</span> handler<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For a container to know that as an implementation of <code>http.Handler</code> is
necessary to use, we use the option <code>di.As()</code>. The arguments of this
option must be a pointer(s) to an interface like <code>new(Endpoint)</code>.</p> <blockquote><p>This syntax may seem strange, but I have not found a better way to
specify the interface.</p></blockquote> <p>Updated container initialization code:</p> <div class="language-go extra-class"><pre class="language-go"><code>container <span class="token operator">:=</span> inject<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
	<span class="token comment">// provide http server</span>
	inject<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServer<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">// provide http serve mux as http.Handler interface</span>
	inject<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServeMux<span class="token punctuation">,</span> inject<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Now container uses provide <code>*http.ServeMux</code> as <code>http.Handler</code> in server
constructor. Using interfaces contributes to writing more testable code.</p> <h3 id="groups"><a href="#groups" class="header-anchor">#</a> Groups</h3> <p>Container automatically groups all implementations of interface to
<code>[]&lt;interface&gt;</code> group. For example, provide with
<code>inject.As(new(http.Handler)</code> automatically creates a group
<code>[]http.Handler</code>.</p> <p>Let's add some http controllers using this feature. Controllers have
typical behavior. It is registering routes. At first, will create an
interface for it.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Controller is an interface that can register its routes.</span>
<span class="token keyword">type</span> Controller <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>mux <span class="token operator">*</span>http<span class="token punctuation">.</span>ServeMux<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we will write controllers and implement <code>Controller</code> interface.</p> <h5 id="ordercontroller"><a href="#ordercontroller" class="header-anchor">#</a> OrderController</h5> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OrderController is a http controller for orders.</span>
<span class="token keyword">type</span> OrderController <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// NewOrderController creates a auth http controller.</span>
<span class="token keyword">func</span> <span class="token function">NewOrderController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>OrderController <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>OrderController<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// RegisterRoutes is a Controller interface implementation.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>OrderController<span class="token punctuation">)</span> <span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>mux <span class="token operator">*</span>http<span class="token punctuation">.</span>ServeMux<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/orders&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>RetrieveOrders<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Retrieve loads orders and writes it to the writer.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>OrderController<span class="token punctuation">)</span> <span class="token function">RetrieveOrders</span><span class="token punctuation">(</span>writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> request <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// implementation</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="usercontroller"><a href="#usercontroller" class="header-anchor">#</a> UserController</h5> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// UserController is a http endpoint for a user.</span>
<span class="token keyword">type</span> UserController <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// NewUserController creates a user http endpoint.</span>
<span class="token keyword">func</span> <span class="token function">NewUserController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>UserController <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>UserController<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// RegisterRoutes is a Controller interface implementation.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>mux <span class="token operator">*</span>http<span class="token punctuation">.</span>ServeMux<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>RetrieveUsers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Retrieve loads users and writes it using the writer.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">RetrieveUsers</span><span class="token punctuation">(</span>writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> request <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// implementation</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Just like in the example with interfaces, we will use <code>inject.As()</code>
provide option.</p> <div class="language-go extra-class"><pre class="language-go"><code>container <span class="token operator">:=</span> inject<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
	di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServer<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// provide http server</span>
	di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServeMux<span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment">// provide http serve mux</span>
	<span class="token comment">// endpoints</span>
	di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewOrderController<span class="token punctuation">,</span> di<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>Controller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// provide order controller</span>
	di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewUserController<span class="token punctuation">,</span> di<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>Controller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// provide user controller</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Now, we can use <code>[]Controller</code> group in our mux. See updated code:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// NewServeMux creates a new http serve mux.</span>
<span class="token keyword">func</span> <span class="token function">NewServeMux</span><span class="token punctuation">(</span>controllers <span class="token punctuation">[</span><span class="token punctuation">]</span>Controller<span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>ServeMux <span class="token punctuation">{</span>
	mux <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>ServeMux<span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> controller <span class="token operator">:=</span> <span class="token keyword">range</span> controllers <span class="token punctuation">{</span>
		controller<span class="token punctuation">.</span><span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>mux<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> mux
<span class="token punctuation">}</span>
</code></pre></div><h2 id="advanced-features"><a href="#advanced-features" class="header-anchor">#</a> Advanced features</h2> <h3 id="named-definitions"><a href="#named-definitions" class="header-anchor">#</a> Named definitions</h3> <p>In some cases you have more than one instance of one type. For example
two instances of database: master - for writing, slave - for reading.</p> <p>First way is a wrapping types:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// MasterDatabase provide write database access.</span>
<span class="token keyword">type</span> MasterDatabase <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>Database
<span class="token punctuation">}</span>

<span class="token comment">// SlaveDatabase provide read database access.</span>
<span class="token keyword">type</span> SlaveDatabase <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>Database
<span class="token punctuation">}</span>
</code></pre></div><p>Second way is a using named definitions with <code>di.WithName()</code> provide
option:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// provide master database</span>
di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewMasterDatabase<span class="token punctuation">,</span> di<span class="token punctuation">.</span><span class="token function">WithName</span><span class="token punctuation">(</span><span class="token string">&quot;master&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// provide slave database</span>
di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewSlaveDatabase<span class="token punctuation">,</span> di<span class="token punctuation">.</span><span class="token function">WithName</span><span class="token punctuation">(</span><span class="token string">&quot;slave&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>If you need to extract it from container use <code>di.Name()</code> extract
option.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> db <span class="token operator">*</span>Database
container<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>db<span class="token punctuation">,</span> di<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token string">&quot;master&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>If you need to provide named definition in other constructor use
<code>di.Parameter</code> with embedding.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ServiceParameters</span>
<span class="token keyword">type</span> ServiceParameters <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	di<span class="token punctuation">.</span>Parameter
	
	<span class="token comment">// use `di` tag for the container to know that field need to be injected.</span>
	MasterDatabase <span class="token operator">*</span>Database <span class="token string">`di:&quot;master&quot;`</span>
	SlaveDatabase <span class="token operator">*</span>Database  <span class="token string">`di:&quot;slave&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewService creates new service with provided parameters.</span>
<span class="token keyword">func</span> <span class="token function">NewService</span><span class="token punctuation">(</span>parameters ServiceParameters<span class="token punctuation">)</span> <span class="token operator">*</span>Service <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Service<span class="token punctuation">{</span>
		MasterDatabase<span class="token punctuation">:</span>  parameters<span class="token punctuation">.</span>MasterDatabase<span class="token punctuation">,</span>
		SlaveDatabase<span class="token punctuation">:</span> parameters<span class="token punctuation">.</span>SlaveDatabase<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="optional-parameters"><a href="#optional-parameters" class="header-anchor">#</a> Optional parameters</h3> <p>Also <code>di.Parameter</code> provide ability to skip dependency if it not exists
in container.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ServiceParameter</span>
<span class="token keyword">type</span> ServiceParameter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	di<span class="token punctuation">.</span>Parameter
	
	Logger <span class="token operator">*</span>Logger <span class="token string">`di:&quot;optional&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Constructors that declare dependencies as optional must handle the
case of those dependencies being absent.</p></blockquote> <p>You can use naming and optional together.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ServiceParameter</span>
<span class="token keyword">type</span> ServiceParameter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	di<span class="token punctuation">.</span>Parameter
	
	StdOutLogger <span class="token operator">*</span>Logger <span class="token string">`di:&quot;stdout&quot;`</span>
	FileLogger   <span class="token operator">*</span>Logger <span class="token string">`di:&quot;file,optional&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="parameter-bag"><a href="#parameter-bag" class="header-anchor">#</a> Parameter Bag</h3> <p>If you need to specify some parameters on definition level you can use
<code>inject.ParameterBag</code> provide option. This is a <code>map[string]interface{}</code>
that transforms to <code>di.ParameterBag</code> type.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Provide server with parameter bag</span>
di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewServer<span class="token punctuation">,</span> di<span class="token punctuation">.</span>ParameterBag<span class="token punctuation">{</span>
	<span class="token string">&quot;addr&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// NewServer create a server with provided parameter bag. Note: use di.ParameterBag type.</span>
<span class="token comment">// Not inject.ParameterBag.</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>pb di<span class="token punctuation">.</span>ParameterBag<span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Server <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span> pb<span class="token punctuation">.</span><span class="token function">RequireString</span><span class="token punctuation">(</span><span class="token string">&quot;addr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="prototypes"><a href="#prototypes" class="header-anchor">#</a> Prototypes</h3> <p>If you want to create a new instance on each extraction use
<code>di.Prototype()</code> provide option.</p> <div class="language-go extra-class"><pre class="language-go"><code>di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewRequestContext<span class="token punctuation">,</span> di<span class="token punctuation">.</span><span class="token function">Prototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>todo: real use case</p></blockquote> <h3 id="cleanup"><a href="#cleanup" class="header-anchor">#</a> Cleanup</h3> <p>If a provider creates a value that needs to be cleaned up, then it can
return a closure to clean up the resource.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewFile</span><span class="token punctuation">(</span>log Logger<span class="token punctuation">,</span> path Path<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    cleanup <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> f<span class="token punctuation">,</span> cleanup<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>After <code>container.Cleanup()</code> call, it iterate over instances and call
cleanup function if it exists.</p> <div class="language-go extra-class"><pre class="language-go"><code>container <span class="token operator">:=</span> di<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
	<span class="token comment">// ...</span>
    di<span class="token punctuation">.</span><span class="token function">Provide</span><span class="token punctuation">(</span>NewFile<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment">// do something</span>
container<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// file was closed</span>
</code></pre></div><blockquote><p>Cleanup now work incorrectly with prototype providers.</p></blockquote> <h2 id="visualization"><a href="#visualization" class="header-anchor">#</a> Visualization</h2> <p>Dependency graph may be presented via
(<a href="https://www.graphviz.org/" target="_blank" rel="noopener noreferrer">Graphviz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>). For it, load string
representation:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> graph <span class="token operator">*</span>di<span class="token punctuation">.</span>di<span class="token punctuation">.</span>Graph
<span class="token keyword">if</span> err <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// handle err</span>
<span class="token punctuation">}</span>

dotGraph <span class="token operator">:=</span> graph<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// use string representation</span>
</code></pre></div><p>And paste it to <a href="https://dreampuf.github.io/GraphvizOnline" target="_blank">graphviz online tool</a>:</p> <img src="https://github.com/defval/inject/raw/master/graph.png"></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/microservices/naming_eureka.html" class="prev">
        Eureka
      </a></span> <span class="next"><a href="/extendpoint/hostservice.html">
        扩展点 - HostService接口
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fbf17916.js" defer></script><script src="/assets/js/2.fff6d63b.js" defer></script><script src="/assets/js/16.a7f4b20a.js" defer></script>
  </body>
</html>
